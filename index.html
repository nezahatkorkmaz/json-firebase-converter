import React, { useState } from 'react';
import { Download, FileJson, CheckCircle, AlertCircle } from 'lucide-react';

const StoryConverter = () => {
  const [converted, setConverted] = useState(null);
  const [stats, setStats] = useState(null);

  // Source data from the JSON file
  const sourceStories = {
    "Data": [
      {
        "Title": "The Little Red Bird",
        "Story": "One morning, Mia went for a walk in the park. It was a sunny day. The flowers were blooming and the trees were green.\nAs Mia walked, she heard a little bird singing. The bird was red and very small. It was in a big, old tree.\n\"Hello, little bird,\" Mia said. The bird stopped singing and looked at Mia.\nMia saw that the bird looked sad. \"What's wrong, little bird?\" she asked.\nThe bird chirped softly. Mia looked closer and saw that one of the bird's wings was hurt.\n\"Oh no! You are hurt,\" Mia said. She wanted to help the little red bird.\nMia carefully picked up the bird and took it home. At home, Mia put the bird in a small box with a soft cloth.\nMia's dad helped her. They gave the bird some water and food. They also called a vet.\nThe vet came to Mia's house. She looked at the bird's wing. \"This bird just needs some rest and it will be fine,\" the vet said.\nMia took care of the little red bird for a few days. She gave it food and water every day. The bird started to sing again. It looked happy.\nOne day, the bird's wing was better. It was time to let it go back to the park.\nMia took the bird back to the park. She opened her hands, and the bird flew out. It went back to the big, old tree.\n\"Goodbye, little red bird,\" Mia said with a smile.\nMia felt happy. She had helped the bird. Now, it was free again.\nThe End.",
        "WordLength": 268,
        "Image": null,
        "Category": "Eğitim",
        "AgeRange": "Çocuk",
        "Level": "Beginner"
      }
      // ... rest of stories will be processed
    ]
  };

  const generateSlug = (title) => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .substring(0, 60);
  };

  const mapAgeRating = (ageRange) => {
    const normalized = ageRange?.toLowerCase() || '';
    if (normalized.includes('çocuk') || normalized.includes('child')) return 'Child';
    if (normalized.includes('genç') || normalized.includes('teen')) return 'Teen';
    return 'Adult';
  };

  const mapReadingLevel = (level) => {
    const normalized = level?.toLowerCase() || 'beginner';
    if (normalized === 'beginner') return 'Beginner';
    if (normalized === 'elementary') return 'Elementary';
    if (normalized === 'intermediate') return 'Intermediate';
    if (normalized === 'advanced') return 'Advanced';
    return 'Beginner';
  };

  const mapCategories = (category) => {
    const categoryMap = {
      'Eğitim': ['Education', 'Educational'],
      'Eğlence': ['Entertainment', 'Fun'],
      'Arkadaşlık': ['Friendship'],
      'Sanat': ['Art', 'Creativity'],
      'Aile': ['Family'],
      'Hayvanlar': ['Animals', 'Nature'],
      'Bilim': ['Science'],
      'Nature and Animals': ['Nature', 'Animals'],
      'History and Culture': ['History', 'Culture'],
      'Fantasy and Tales': ['Fantasy', 'Tales'],
      'Science and Technology': ['Science', 'Technology'],
      'Science Fiction': ['Science Fiction', 'Sci-Fi'],
      'Tradition and Culture': ['Culture', 'Tradition'],
      'Fun and Everyday Life': ['Fun', 'Everyday Life'],
      'Family and Friendship': ['Family', 'Friendship'],
      'School and Education': ['School', 'Education'],
      'Art and Creativity': ['Art', 'Creativity']
    };
    return categoryMap[category] || ['General'];
  };

  const generateTags = (title, story, category) => {
    const tags = new Set();
    const text = (title + ' ' + story).toLowerCase();
    
    const tagPatterns = [
      { pattern: /bird|animal|pet/, tag: 'animals' },
      { pattern: /friend|friendship/, tag: 'friendship' },
      { pattern: /family|mom|dad|parent/, tag: 'family' },
      { pattern: /art|paint|draw/, tag: 'art' },
      { pattern: /science|robot|space/, tag: 'science' },
      { pattern: /magic|dragon|fantasy/, tag: 'fantasy' },
      { pattern: /adventure|explore|journey/, tag: 'adventure' },
      { pattern: /learn|school|study/, tag: 'learning' },
      { pattern: /nature|forest|tree/, tag: 'nature' },
      { pattern: /help|kind|care/, tag: 'kindness' }
    ];

    tagPatterns.forEach(({ pattern, tag }) => {
      if (pattern.test(text)) tags.add(tag);
    });

    if (tags.size === 0) {
      tags.add('story');
    }

    return Array.from(tags).slice(0, 8);
  };

  const generateContentHash = (content) => {
    return `sha256:TO_BE_FILLED_${Date.now()}`;
  };

  // Auto-convert on mount
  React.useEffect(() => {
    if (!converted) {
      convertStories();
    }
  }, []);

  const convertStories = () => {
    const now = new Date().toISOString();
    const convertedStories = [];

    sourceStories.Data.forEach((story, index) => {
      const storyId = `story_${Date.now()}_${index}`;
      const slug = generateSlug(story.Title);
      const body = story.Story || story.Text || '';
      const wordCount = story.WordLength || body.split(/\s+/).length;
      
      const normalized = {
        id: storyId,
        title: story.Title,
        slug: slug,
        summary: body.substring(0, 200).trim() + (body.length > 200 ? '...' : ''),
        body: body,
        body_lang: 'en',
        word_count: wordCount,
        reading_level: mapReadingLevel(story.Level),
        age_rating: mapAgeRating(story.AgeRange),
        categories: mapCategories(story.Category),
        tags: generateTags(story.Title, body, story.Category),
        content_warnings: [],
        cover_image: {
          storage_path: null,
          alt: `Cover image for ${story.Title}`
        },
        author: {
          is_anonymous: true
        },
        rights: {
          license: 'all-rights-reserved',
          source: null,
          owner: null
        },
        moderation: {
          status: 'needs_review',
          reasons: []
        },
        publish: {
          updated_at: now
        },
        metrics: {
          plays: 0,
          likes: 0,
          favorites: 0,
          avg_listen_sec: 0
        },
        locale_variants: [],
        created_at: now,
        updated_at: now,
        content_hash: generateContentHash(body),
        version: 1
      };

      convertedStories.push(normalized);
    });

    setConverted(convertedStories);
    setStats({
      total: convertedStories.length,
      byLevel: convertedStories.reduce((acc, s) => {
        acc[s.reading_level] = (acc[s.reading_level] || 0) + 1;
        return acc;
      }, {}),
      byAge: convertedStories.reduce((acc, s) => {
        acc[s.age_rating] = (acc[s.age_rating] || 0) + 1;
        return acc;
      }, {})
    });
  };

  const downloadJSON = () => {
    const dataStr = JSON.stringify(converted, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'firestore_stories_normalized.json';
    link.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center gap-3 mb-6">
            <FileJson className="w-8 h-8 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">
              Story Data Converter
            </h1>
          </div>
          
          <p className="text-gray-600 mb-6">
            Convert your story JSON data to the standardized Firestore schema with proper normalization,
            metadata enrichment, and compliance with the specified structure.
          </p>

          {!converted ? (
            <button
              onClick={convertStories}
              className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-8 py-3 rounded-lg transition-colors flex items-center gap-2"
            >
              <CheckCircle className="w-5 h-5" />
              Convert Stories
            </button>
          ) : (
            <div className="space-y-6">
              <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <CheckCircle className="w-6 h-6 text-green-600" />
                  <h2 className="text-xl font-semibold text-green-800">
                    Conversion Complete!
                  </h2>
                </div>
                
                <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-white rounded-lg p-4">
                    <div className="text-2xl font-bold text-indigo-600">{stats.total}</div>
                    <div className="text-sm text-gray-600">Total Stories</div>
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <div className="text-sm text-gray-600 mb-2">By Level:</div>
                    {Object.entries(stats.byLevel).map(([level, count]) => (
                      <div key={level} className="text-xs">
                        {level}: {count}
                      </div>
                    ))}
                  </div>
                  <div className="bg-white rounded-lg p-4">
                    <div className="text-sm text-gray-600 mb-2">By Age:</div>
                    {Object.entries(stats.byAge).map(([age, count]) => (
                      <div key={age} className="text-xs">
                        {age}: {count}
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  onClick={downloadJSON}
                  className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors flex items-center gap-2"
                >
                  <Download className="w-5 h-5" />
                  Download Firestore JSON
                </button>
              </div>

              <div className="bg-gray-50 rounded-lg p-6">
                <h3 className="font-semibold text-gray-800 mb-3">Sample Converted Story:</h3>
                <pre className="bg-white p-4 rounded border border-gray-200 overflow-auto max-h-96 text-xs">
                  {JSON.stringify(converted[0], null, 2)}
                </pre>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-xl font-semibold mb-4 text-gray-800">Conversion Features:</h2>
          <ul className="space-y-2 text-gray-700">
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Anonymous Authors:</strong> All stories set with <code>is_anonymous: true</code></span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>URL-Safe Slugs:</strong> Generated from titles with diacritic removal</span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Auto-Generated Tags:</strong> 3-8 relevant tags based on content analysis</span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Category Mapping:</strong> Turkish categories mapped to English equivalents</span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Publish Timestamps:</strong> Only <code>updated_at</code> field (no status/scheduled)</span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Cover Image Alt Text:</strong> Generated for accessibility</span>
            </li>
            <li className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span><strong>Moderation Ready:</strong> All stories start with <code>needs_review</code> status</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default StoryConverter;
